## HAL库中I2C使用DMA遇到的问题

目前项目需要使用I2C设备，使用cubemx生成的I2C并使用DMA的代码无法正常运行。第一次使用I2C正常，如果还想再次使用，错误代码返回I2C在忙。我以为我哪里没有设置好，导致官方代码有问题，网上搜了一天仍然没有解决。和大佬讨论后，大佬说：像很多EEPROM等I2C设备，它的I2C速度没有STM32快，导致STM32发送数据后，I2C设备没有应答，然后导致我上述问题。最后使用逻辑分析仪发现，I2C从设备(EEPROM)是应答了的。真正的原因是在完成第一次I2C访问后，SCL一直处于低电平。没有恢复正常的高电平。![t1](./images/%E5%AD%A6%E4%B9%A0%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E5%B0%8F%E9%97%AE%E9%A2%98/01.png)
碰到同样问题,调试一天发现 应该是 HAL库配置的时候没有把I2C的 event interrypt 勾选.以至于BTF标志位没有被清零,导致SCL被拉低.解决办法:配置HAL库时,勾选event interrypt 中断. 或者 手动清零.